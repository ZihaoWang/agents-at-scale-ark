# DevSpace configuration for ark service
version: v2beta1

images:
  ark-controller:
    image: ark-controller
    dockerfile: ./Dockerfile
    context: .

pipelines:
  deploy: |-
    build_images --all
    create_deployments --all
  dev: |-
    create_deployments --all
    start_dev --all

deployments:
  ark-controller:
    namespace: ark-system
    helm:
      chart:
        path: ./dist/chart
      values:
        controllerManager:
          container:
            image:
              repository: ${runtime.images.ark-controller.image}
              tag: ${runtime.images.ark-controller.tag}
            resources:
              limits:
                memory: "2048Mi"
                cpu: "2000m"
              requests:
                memory: "256Mi"
                cpu: "200m"
          # Override security context for development
          securityContext:
            runAsNonRoot: false
        webhook:
          enable: true

dev:
  ark-controller:
    imageSelector: ark-controller
    devImage: golang:1.24.11-bookworm
    command:
      ["sh", "-c", "cd /app && GOTOOLCHAIN=auto go run cmd/main.go --leader-elect=false"]
    namespace: ark-system
    logs:
      lastLines: 50
    # File synchronization for hot reload
    sync:
      - path: .:/app
        startContainer: true
        disableDownload: true
        uploadExcludeFile: .dockerignore
        onUpload:
          restartContainer: true
    # Enable SSH for IDE integration
    ssh:
      enabled: true

profiles:
  - name: minikube
    patches:
      - op: replace
        path: deployments/ark-controller/helm/values/controllerManager/container/resources/limits/memory
        value: "512Mi"
      - op: replace
        path: deployments/ark-controller/helm/values/controllerManager/container/resources/limits/cpu
        value: "500m"
      - op: replace
        path: deployments/ark-controller/helm/values/controllerManager/container/resources/requests/memory
        value: "128Mi"
      - op: replace
        path: deployments/ark-controller/helm/values/controllerManager/container/resources/requests/cpu
        value: "50m"
      - op: replace
        path: deployments/ark-controller/helm/values/webhook/enable
        value: false
      - op: add
        path: deployments/ark-controller/helm/values/certmanager
        value:
          enable: false
      - op: add
        path: deployments/ark-controller/helm/values/metrics
        value:
          enable: false
